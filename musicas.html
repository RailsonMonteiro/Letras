<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Música & Letra</title>
<link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.6.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>
<link rel="icon" sizes="32" href="icon-512.png" />
<link rel="stylesheet" href="css/style_muisc.css">

</head>
<body>
<div class="container">
  <!-- Player fixo -->
  <div id="playerBar">
    <div id="progress"><span></span></div>
    <div id="time">0:00 / 0:00</div>
  </div>
  <a href="index.html"><i class="fi fi-rr-undo">Voltar</i></a>
  <div id="musica"></div>
</div>

<div class="botoes">
  <button class="btn-audio">Play</button>
  <button class="btn-pause"><i class="fi fi-rr-play"></i></button>
  <button class="btn-stop"><i class="fi fi-rr-stop"></i></button>
</div>

<script>
async function carregarMusicas(){
  try {
    const resp = await fetch('musicas.json');
    if(!resp.ok) throw new Error('JSON externo não encontrado');
    return await resp.json();
  } catch(e) {
    return [
      {
        "id":1,
        "titulo":"Joyce",
        "artista":"Artista 1",
        "versos":"Verso 1\nVerso 2\nVerso 3",
        "refrao":"Refrão",
        "estilo":{"cor":"#333","tamanho":"16px","fonte":"Arial"},
        "estiloRefrao":{"cor":"red","tamanho":"20px","negrito":true}
      }
    ];
  }
}

(async ()=>{
  const musicas = await carregarMusicas();
  const params = new URLSearchParams(window.location.search);
  const id = parseInt(params.get("id"));
  const m = musicas.find(x=>x.id===id);
  const div = document.getElementById("musica");

  if(m){
    const estilo = m.estilo || {};
    const cssVersos = `
      color:${estilo.cor || '#333'};
      font-size:${estilo.tamanho || '18px'};
      font-family:${estilo.fonte || 'Arial'};
      font-weight:${estilo.negrito ? 'bold' : 'normal'};
      font-style:${estilo.italico ? 'italic' : 'normal'};
      text-decoration:${estilo.sublinhado ? 'underline' : 'none'};
    `;
    const estiloRefrao = m.estiloRefrao || {};
    const cssRefrao = `
      color:${estiloRefrao.cor || '#007bff'};
      font-size:${estiloRefrao.tamanho || '18px'};
      font-family:${estiloRefrao.fonte || 'Arial'};
      font-weight:${estiloRefrao.negrito ? 'bold' : 'normal'};
      font-style:${estiloRefrao.italico ? 'italic' : 'normal'};
      text-decoration:${estiloRefrao.sublinhado ? 'underline' : 'none'};
    `;

    div.innerHTML = `
      <h1>${m.titulo}</h1>
      <h2>${m.artista}</h2>
      <pre style="${cssVersos}">${m.versos || m.letra || ""}</pre>
      ${m.refrao ? `<pre class="refrao" style="${cssRefrao}">${m.refrao}</pre>` : ""}
    `;

    const btn = document.querySelector(".btn-audio");
    const btnPause = document.querySelector(".btn-pause");
    const btnStop  = document.querySelector(".btn-stop");

    let modo = "voz";
    const audio = new Audio();
    const playerBar = document.getElementById("playerBar");
    const progress = document.querySelector("#progress span");
    const time = document.getElementById("time");

    function tocar() {
      let arquivo = modo==="voz" ? `musicas/${m.titulo}-voz.mp3` : `musicas/${m.titulo}-pb.mp3`;
      btn.textContent = modo==="Voz" ? "Voz" : "PB";
      audio.src = arquivo;
      audio.play();
      playerBar.style.display = "flex";
      btnPause.innerHTML = '<i class="fi fi-rr-pause"></i>';
    }

    btn.addEventListener("click", ()=>{
      if(!audio.paused){
        audio.pause();
        audio.currentTime = 0;
        modo = (modo==="voz" ? "pb" : "voz");
        tocar();
      } else {
        tocar();
      }
    });

    // Toggle Play/Pause
    btnPause.addEventListener("click", ()=>{
      if(audio.paused){
        audio.play();
        btnPause.innerHTML = '<i class="fi fi-rr-pause"></i>';
      } else {
        audio.pause();
        btnPause.innerHTML = '<i class="fi fi-rr-play"></i>';
      }
    });

    btnStop.addEventListener("click", ()=>{
      audio.pause();
      audio.currentTime = 0;
      progress.style.width = "0%";
      playerBar.style.display = "none";
      btnPause.innerHTML = '<i class="fi fi-rr-play"></i>';
    });

    audio.addEventListener("timeupdate", ()=>{
      if(audio.duration){
        let percent = (audio.currentTime / audio.duration) * 100;
        progress.style.width = percent+"%";
        let min = Math.floor(audio.currentTime / 60);
        let sec = Math.floor(audio.currentTime % 60).toString().padStart(2,"0");
        let minT = Math.floor(audio.duration / 60);
        let secT = Math.floor(audio.duration % 60).toString().padStart(2,"0");
        time.textContent = `${min}:${sec} / ${minT}:${secT}`;
      }
    });

    audio.addEventListener("ended", ()=>{
      progress.style.width = "0%";
      playerBar.style.display = "none";
    });

  } else {
    div.innerHTML="<p>Música não encontrada.</p>";
  }
})();
</script>

<footer> 
  Copyright © 2025 Railson Monteiro. Todos os direitos reservados.
</footer>
</body>
</html>
